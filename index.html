<html>
<head>
<title>Guess Who</title>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script src="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script>

<body>
<h1>Guess Who?</h1>
<div id="init">
	<h2> Step 1: Pick a character for the AI to try and guess.</h2>
	<div style="text-align:center;">
		<svg id="human_options" width="800" height="600"> </svg>
		<div id="step2" style="visibility: hidden;">
			<h2> Step 2: Start the Game! </h2>
			<div style="text-align:center;">
				<button class="button" style="vertical-align:middle" onclick="start()"><span>Start </span></button>
			</div>
		</div>
	</div>
</div>

<div id="game" style="visibility: hidden; text-align:center;">
	<svg id="images" width="800" height="600"> </svg>
	<svg id="output" width="800" height="600"> 
	<foreignObject x="-350" y="120", height="100", width="1500">
                <input type="text" id="input1"> </input> </br>
                <button id="ask_ai_button" class="btn" style="vertical-align:middle" onclick="ask_ai();"><span> Ask AI </span></button>
    </foreignObject>
    <foreignObject x="-350" y="260", height="100", width="1500" style="visibility: hidden;">
                <input type="text" id="input2"> </input>
                </br>
                <button id="button2" class="btn" style="vertical-align:middle; visibility: hidden;" onclick="click_button2();"><span> Done With Turn </span></button>
    </foreignObject>
	</svg>
	<div style="text-align:center;">
	<button class="button" style="vertical-align:middle;" onclick="location.reload();"><span>Reset </span></button>
	</div>
	<h2> Sample Questions: </h2>
	<h3 >Is your character number 5?</h3>
	<h3 >Is your character male?</h3>
	<h3>Is your character smiling?</h3>
	<h3>Does your character have dark hair?</h3>
</div>
</body>

<script>
var human_choice;
var human_question;
var ai_question;
var ai_choice;
var game_over = false;

var dir = "pics1";

var svg = d3.select("#human_options");

var width = +svg.attr("width"); var height = +svg.attr("height");

var padding_top = 50;
var padding_lr = 20;
var padding = 4;
var img_dim = (width - 2*padding_lr-5*padding)/6;
var img_number = 0;
for (var row = 0; row < 4; row++){
    for (var col = 0; col < 6; col++){
        svg.append("image")
            .attr("id","human_img_" + img_number)
            .attr("class", "clickable_image")
            .attr("x", padding_lr + (col)*padding + col*img_dim)
            .attr("y", padding_top+ (row)*padding + (row)*img_dim)
            .attr("height", img_dim)
            .attr("width", img_dim)
            .attr("href", dir+"/pic" + img_number + ".jpg")
            .attr("xlink:href", dir+"/pic" + img_number + ".jpg")
            .on("click", function(){ chooseHumanImg(this.id);});
        img_number++;
    }
}

function chooseHumanImg(img_id){
	var numberPattern = /\d+/g;
	svg.selectAll("*").remove();
	var pic_number = Number(img_id.match(numberPattern)[0]);
	human_choice = pic_number;
	document.getElementById('human_options').setAttribute("height", "300px");
	svg.append("image")
		.attr("x", width/2-270/2)
		.attr("y", 0)
		.attr("height", 270)
		.attr("width", 270)
		.attr("href", dir+"/pic" + pic_number + ".jpg")
        .attr("xlink:href", dir+"/pic" + pic_number + ".jpg");
    document.getElementById("step2").style.visibility="visible";
}

function start(){
	human_question = "";
	var elem = document.getElementById("init");
	elem.parentNode.removeChild(elem);
	ai_choice = Math.floor(Math.random() * 24);
	document.getElementById("game").style.visibility="visible";
	human_turn();
}

// GAME PLAY CODE BELOW

var images_svg = d3.select("#images");
var output_svg = d3.select("#output");
var removed_ai = new Array(24+1).join('0').split('').map(parseFloat);
var removed_human = new Array(24+1).join('0').split('').map(parseFloat);
var is_human_turn = true;
var turn = 0;
var yes = ["yes", "yup", "yeah", "yes!", "yeah!", "yup!", "yea", "yea!", "affirmative", "yas", "yaaass"];
var no = ["no", "nope", "nah", "no!", "nope!", "nah!", "negative"];
var idk = ["I don't know..", "not sure", "I don't understand your question :(", "No comprendo", "lol idk sorry", "Alas I was not programmed to understand your question."];


function human_turn(){
	document.body.style.backgroundColor = "#e3e7ea";
	turn++;
	is_human_turn = true;
	images_svg.selectAll("*").remove();
	output_svg.selectAll("text").remove();
	display_images();
	set_up_human();
	for (i=0; i<removed_human.length; i++){
		if (removed_human[i]==1){
			black_out_image("human_img_"+i);
		}
	}
}

function ai_turn(){
	document.body.style.backgroundColor = "#ffe5e5";
	turn++;
	human_question = "";
	is_human_turn = false;
	images_svg.selectAll("*").remove();
	output_svg.selectAll("text").remove();
	display_images();
	set_up_ai();
	for (i=0; i<removed_ai.length; i++){
		if (removed_ai[i]==1){
			black_out_image("ai_img_"+i);
		}
	}

}

function display_images(){
	var svg = images_svg;
	var width = +svg.attr("width"); var height = +svg.attr("height");
	var padding_top = 50;
	var padding_lr = 20;
	var padding = 4;
	var img_dim = (width - 2*padding_lr-5*padding)/6;
	var img_number = 0;
	var type = "human_img_";
	if (!is_human_turn){
		type = "ai_img_";
	}
	for (var row = 0; row < 4; row++){
    	for (var col = 0; col < 6; col++){
    		var xdisp = 2;
    		if (img_number < 10){
    			xdisp = 5;
    		}
        	svg.append("image")
            .attr("id",type + img_number)
            .attr("class", "clickable_image")
            .attr("x", padding_lr + (col)*padding + col*img_dim)
            .attr("y", padding_top+ (row)*padding + (row)*img_dim)
            .attr("height", img_dim)
            .attr("width", img_dim)
            .attr("href", dir+"/pic" + img_number + ".jpg")
            .attr("xlink:href", dir+"/pic" + img_number + ".jpg")
            .on("click", function(){black_out_image(this.id);});
            svg.append("rect")
            .attr("x", padding_lr + (col)*padding + col*img_dim)
            .attr("y", padding_top+ (row)*padding + (row)*img_dim)
            .attr("height", 20)
            .attr("width", 20)
            .attr("fill", "white");
            svg.append("text")
            .text(img_number)
            .attr("x", padding_lr + (col)*padding + col*img_dim +xdisp)
            .attr("y",padding_top+ (row)*padding + (row)*img_dim + 15)
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .attr("fill","black");

        img_number++;
    	}
	}

}

function set_up_human(){
	var svg = output_svg;
	var width = +svg.attr("width"); var height = +svg.attr("height");
	svg.append("text").text("Human Turn").attr("class", "output_title").attr("x", width/2).attr("y", 40).style("fill","#110D8C");
	svg.append("text").text('Question for AI (must have "yes" or "no" answer):').attr("class", "output_text").attr("x", 30).attr("y", 100).style("fill","#110D8C");
	svg.append("text").text('Human Choice').attr("class", "output_text").attr("x", 500).attr("y", height-175).style("font-size", "20px").style("fill","#110D8C");
    svg.append("text").text('AI Choice').attr("class", "output_text").attr("x", 210).attr("y", height-175).style("font-size", "20px").style("fill","#110D8C");
	if (turn==1){
		svg.append("image").attr("x", 505).attr("y", height-165).attr("height", img_dim).attr("width", img_dim).attr("href", dir+"/pic" + human_choice + ".jpg").attr("xlink:href", dir+"/pic" + human_choice + ".jpg");
		svg.append("image").attr("id", "ai_img_choice").attr("class","clickable_image").attr("x", 195).attr("y", height-165).attr("height", img_dim).attr("width", img_dim).attr("href", dir+"/pic" + ai_choice + ".jpg").attr("xlink:href", dir+"/pic" + ai_choice + ".jpg")
			.on("click", function(){black_out_ai_choice();});
		black_out_ai_choice();

	}
	document.getElementById('input1').value=human_question;
	document.getElementById('input2').value=""; 
	document.getElementById("button2").style.visibility="hidden";
	document.getElementById("input2").style.visibility="hidden";
	document.getElementById("ask_ai_button").style.visibility="visible";
}

function ask_ai(){
	var svg = output_svg;
	human_question = document.getElementById('input1').value;
	if (human_question.length == 0){
		window.alert("Please type in a question.");
		return;
	}
	document.getElementById("ask_ai_button").style.visibility="hidden";
	svg.append("text").text('Answer from AI:').attr("class", "output_text").attr("x", 30).attr("y", 240).style("fill","#110D8C");
	document.getElementById("input2").style.visibility="visible";
	document.getElementById('input2').value=get_ai_answer(); 
	if (!game_over){
		document.getElementById("button2").style.visibility="visible";
	}
	document.getElementById("button2").innerText = "Done With Turn";
}

function set_up_ai(){
	var svg = output_svg;
	document.getElementById('input1').value=get_ai_question();
	svg.append("text").text("AI Turn").attr("class", "output_title").attr("x", width/2).attr("y", 40).style("fill","#660000");
	svg.append("text").text('Question for human from AI:').attr("class", "output_text").attr("x", 30).attr("y", 100).style("fill","#660000");
	svg.append("text").text('Answer from human:').attr("class", "output_text").attr("x", 30).attr("y", 240).style("fill","#660000");
	svg.append("text").text('Human Choice').attr("class", "output_text").attr("x", 500).attr("y", height-175).style("font-size", "20px").style("fill","#660000");
    svg.append("text").text('AI Choice').attr("class", "output_text").attr("x", 210).attr("y", height-175).style("font-size", "20px").style("fill","#660000");
    document.getElementById("button2").style.visibility="visible";
    document.getElementById("button2").innerText = "Done Answering";
    document.getElementById('input2').value=""; 
}

function black_out_image(id){
	var svg = images_svg;
	var numberPattern = /\d+/g;
	var img_number = Number(id.match(numberPattern)[0]);
    var image = d3.select("#"+id);
    svg.append("rect").attr("id", id+"_blackout").attr("class", "clickable_image")
        .attr("x",image.attr("x")).attr("y",image.attr("y")).attr("width", image.attr("height"))
        .attr("height", image.attr("height")).attr("fill", "black").attr("opacity",0.8)
        .on("click", function(){
            un_black_out_image(this.id);
    });
    if (is_human_turn){
    	removed_human[img_number] = 1;
    }
    else{
    	removed_ai[img_number] = 1;
    }
}

function un_black_out_image(id){
	var svg = images_svg;
	var numberPattern = /\d+/g;
	var rect = d3.select("#"+id);
    rect.remove();
    var pic_number = Number(id.match(numberPattern)[0]);
    if (is_human_turn){
    	removed_human[pic_number] = 0;
    }
    else{
    	removed_ai[pic_number] = 0;
    }
}

function black_out_ai_choice(){
	var svg = output_svg;
	var image = d3.select("#ai_img_choice");
	svg.append("rect").attr("id", "blackout_ai_choice").attr("class", "clickable_image")
        .attr("x",image.attr("x")).attr("y",image.attr("y")).attr("width", image.attr("height"))
        .attr("height", image.attr("height")).attr("fill", "black").attr("opacity",1)
        .on("click", function(){
            un_black_out_ai_choice(this.id);
    });
}

function un_black_out_ai_choice(){
	var svg = output_svg;
	var rect = d3.select("#blackout_ai_choice");
	rect.remove();
}

function click_button2(){
	if (is_human_turn){
		ai_turn();
	}
	else if (document.getElementById("button2").innerText === "Done Answering"){
		if (document.getElementById('input2').value.length == 0){
			window.alert("Please answer the question.");
			return;
		}
		handle_human_answer();
		document.getElementById("button2").innerText = "Done With AI Turn";
	}
	else{
		human_turn();
	}
}

function ai_win(){
	var svg = images_svg;
	svg.selectAll("*").remove();
	svg.append("image")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", 300)
    .attr("width", 800)
    .attr("href", "loser.gif")
    .attr("xlink:href", "loser.gif");
    svg.append("text")
        .text("AI Won. You Lost. How Embarassing.")
        .attr("x", width/2)
        .attr("y", height/2+100)
        .attr("fill", "#660000")
        .style("text-anchor","middle")
        .style("font-weight", "bold")
        .style("font-size","50px")
        .style("font-variant","small-caps");
        document.getElementById("button2").style.visibility="hidden";
        game_over = true;
        un_black_out_ai_choice();
}

var data = new Array(24);;
var categories = [];
var categories_answered = [];
var catToIdx = {};

d3.json(dir+"/data.json", function(d) {
    for (i = 0; i < d["pic0"].length; i++){
        categories.push(Object.keys(d["pic0"][i])[0]);
        catToIdx[Object.keys(d["pic0"][i])[0]] = i;
    }
    for (i = 0; i < 24; i++) {
        data[i] = new Array(categories.length);
        for (j = 0; j<categories.length; j++){
            if (d["pic"+i][j][categories[j]] === "yes"){
                data[i][j] = true;
            }
            else{
                data[i][j] = false;
            }
        }
    }
});

var colors = ["blue","black","brown","yellow","green","red","white","gray"];
var tones = ["light", "dark"];
var lengths = ["short", "long", "round", "square", "medium"];
var genders = {"female":["girl", "woman"],
                "male": ["boy", "man"]};
var adjectives = ["visible", "portrait"];
var negateUserQ = false

/*
 * All important AI Code is below
 */

/*
 * When human asks a question, AI needs to respond with yes or no answer
 */
function get_ai_answer(){
	// check if there is number in string
	var numberPattern = /\d+/g;
	if (human_question.match(numberPattern) != null){
		var number = Number(human_question.match(numberPattern)[0]);
		if (number == ai_choice){
			var svg = images_svg;
			svg.selectAll("*").remove();
			svg.append("image").attr("x", 0).attr("y", 0).attr("height", 600).attr("width", 800).attr("href", "fireworks.gif").attr("xlink:href", "fireworks.gif");
            svg.append("text").text("You Won!").attr("x", width/2).attr("y", height/2).attr("fill", "#110D8C").style("text-anchor","middle").style("font-weight", "bold")
            	.style("font-size","50px").style("font-variant","small-caps");
            document.getElementById("button2").style.visibility="hidden";
            game_over = true;
            un_black_out_ai_choice();
			return "yes";
		}
		else{
			return no[Math.floor(Math.random() * no.length)];
		}
	}
	var current_cat = humanQuestionToCat();
	if (current_cat == null){
		return idk[Math.floor(Math.random() * idk.length)];
	}
	if (data[ai_choice][catToIdx[current_cat]]){
		if (negateUserQ){
			return no[Math.floor(Math.random() * no.length)];
		}
		else{
			return yes[Math.floor(Math.random() * yes.length)];
		}
		
	}
	else{
		if (negateUserQ){
			return yes[Math.floor(Math.random() * yes.length)];
		}
		else{
			return no[Math.floor(Math.random() * no.length)];
		}
	}
}

/*
 * TODO
 * Returns category corresponding to human question
 */
function humanQuestionToCat(){
    negateUserQ = false;
    var hq = human_question.toLowerCase();
    var oldLen = hq.length;
    hq = hq.replace("?", "");
    while(hq.length != oldLen){
        oldLen = hq.length;
        hq = hq.replace("?", "");
    }
    hq = hq.replace(/\s+/g, " ").trim();
    if (catToIdx[hq] != null){
        return hq;
    }
    var words = hq.split(" ");
    if (words.length == 1){
        // might be another gender term
        if (words[0] === "female" || genders["female"].indexOf(words[0]) >= 0){
            negateUserQ = true;
            return "male";
        }
        if (genders["male"].indexOf(words[0]) >= 0){
            return "male";
        }
    }
    else if (words.length == 2){
        // check gender
        if (words[1] === "female" || genders["female"].indexOf(words[1]) >= 0){
            negateUserQ = true;
            return "male";
        }
        if (words[1] === "male" || genders["male"].indexOf(words[1]) >= 0){
            return "male";
        }
    }
    else{
        if (words.indexOf("not") >=0 || words.indexOf("no") >= 0){
            negateUserQ = true;
        }
        while (words.indexOf("not") >= 0){
            var index = words.indexOf("not");
            words.splice(index, 1);
        }
        while (words.indexOf("no") >= 0){
            var index = words.indexOf("no");
            words.splice(index, 1);
        }
        // now just check if last two words are ok
        if (words.length >= 2){
            if (catToIdx[words[words.length-2]+" "+words[words.length-1]] != null){
                return words[words.length-2]+" "+words[words.length-1];
            }
        }
        if (catToIdx[words[words.length-1]] != null){
            return words[words.length-1];
        }
        if (words[words.length-1] === "female" || genders["female"].indexOf(words[words.length-1]) >= 0){
            negateUserQ = true;
            return "male";
        }
        if (genders["male"].indexOf(words[words.length-1]) >= 0){
            return "male";
        }
    }
    return null;
}

/*
 * Returns question for the AI to ask (asks optimally using entropy calculation)
 */
function get_ai_question(){
	if (d3.sum(removed_ai) == removed_ai.length-1){
		// ai question will just ask number of player
		ai_question = String(removed_ai.indexOf(0));
		return "Did you pick character number "+ai_question+"?";
	}
	if (categories_answered.length == categories.length || d3.sum(removed_ai) == removed_ai.length){
        // AI ran out of questions
        window.alert("Ran out of questions, need to deal with this.");
        return;
    }
    else{
        // Need to ask question of max entropy
        var num_possible_cats = categories.length - categories_answered.length;
        var entropy = [];
        var entropy_to_cat = [];
        for (i = 0; i < categories.length; i++){
            if (categories_answered.indexOf(categories[i]) < 0){
                var p = 0;
                var n = 0;
                for (j=0; j < data.length; j++){
                    if (!removed_ai[j]){
                        // ai has not removed this person
                        if (data[j][i]){
                            p++;
                        }
                        else{
                            n++;
                        }
                    }
                }
                entropy.push((-1*(p/(p+n))*Math.log(p/(p+n)))+(-1*(n/(p+n))*Math.log(n/(p+n))));
                entropy_to_cat.push(i);
            }
        }
        var index = entropy.indexOf(d3.max(entropy));
        ai_question = categories[entropy_to_cat[index]];

        categories_answered.push(ai_question);
    }
	return formulateAIQ(ai_question);
}


/*
 * Creates a proper question to output to user.
 */ 
function formulateAIQ(q){
    var words = q.split(" ");
    var first = words[0];
    if (colors.indexOf(first)>=0 || tones.indexOf(first)>=0 || lengths.indexOf(first)>=0){
        return "Do they have " + q + "?";
    }
    else if (adjectives.indexOf(first)>=0){
    	return "Do they have a " + q + "?";
    }
    else{
        return "Are they " + q + "?";
    }
}

/*
 * Deal with human answer to AI question
 */
function handle_human_answer(){
	var human_ans = document.getElementById('input2').value; 
	human_ans = human_ans.toLowerCase();
	var numberPattern = /\d+/g;
	if (yes.indexOf(human_ans)>=0){
		human_ans = true;
	}
	else{
		human_ans = false;
	}
	if (ai_question.match(numberPattern) != null){
		if (human_ans){
			ai_wins();
		}
		else{
			black_out_image("ai_img_"+Number(ai_question.match(numberPattern)[0]));
		}
		return;
	}
	for (i=0; i < 24; i++){
		if (data[i][catToIdx[ai_question]]!=human_ans &&!removed_ai[i]==1){
			black_out_image("ai_img_"+i);
		}
	}
}





</script>

</html>